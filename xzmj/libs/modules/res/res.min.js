var __reflect=this&&this.__reflect||function(e,t,r){e.__class__=t,r?r.push(t):r=[t],e.__types__=e.__types__?r.concat(e.__types__):r},__extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);r.prototype=t.prototype,e.prototype=new r},RES;!function(e){var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),Object.defineProperty(t.prototype,"data",{get:function(){return this.response},set:function(e){this.response=e},enumerable:!0,configurable:!0}),t.prototype.load=function(e){this.open(e),this.send()},t}(egret.HttpRequest);e.RequestLoader=t,__reflect(t.prototype,"RES.RequestLoader",["RES.ILoader"]);var r=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._ref=0,t}return __extends(t,e),t.prototype.$hasRef=function(){return this._ref>0},t.prototype.$addRef=function(){this._ref++,this.$tm=0},t.prototype.$subRef=function(){this._ref--},t}(egret.Texture);e.TexData=r,__reflect(r.prototype,"RES.TexData",["RES.IResData"]),egret.BitmapFont.prototype.getTexture=function(e){var t=this,r=t._textureMap[e];if(!r){var n=t.charList[e];if(!n){var o=t.charTrans;o&&(n=t.charList[o[e]])}n&&(r=t.createTexture(e,n.x,n.y,n.w,n.h,n.ox,n.oy,n.sw,n.sh),t._textureMap[e]=r)}return r},egret.BitmapFont.prototype._getFirstCharHeight=function(){var e=this;if(0==e.firstCharHeight)for(var t in e.charList){var r=e.charList[t];if(r){var n=r.sw;if(void 0===n){var o=r.h;void 0===o&&(o=0);var a=r.oy;void 0===a&&(a=0),n=o+a}if(0>=n)continue;this.firstCharHeight=n;break}}return this.firstCharHeight};var n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._ref=0,t}return __extends(t,e),Object.defineProperty(t.prototype,"data",{get:function(){return this._data},set:function(e){var t=this;t._data=e,t.$texture=e,e?(t._bitmapX=e.$bitmapX-e.$offsetX,t._bitmapY=e.$bitmapY-e.$offsetY):t._bitmapX=t._bitmapY=0},enumerable:!0,configurable:!0}),t.prototype.$hasRef=function(){return this._ref>0},t.prototype.$addRef=function(){this._ref++},t.prototype.$subRef=function(){this._ref--},t}(egret.BitmapFont);e.FontRes=n,__reflect(n.prototype,"RES.FontRes",["RES.IResData"]);var o=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e._fileDic={},e._loadDic={},e._fLoaders=[],e}return __extends(r,t),r.prototype.loadFile=function(t){var r=this,n=t.itm[0],o=r._loadDic[n];if(o)o.push(t);else{r._loadDic[n]=[t];var a=r.getLoader();a.ud=n,a.load(e.$getVirtualUrl(n))}},r.prototype.getRes=function(e){var t=this._fileDic[e];return t&&(t.$tm=egret.getTimer()+1e3),t},r.prototype.hasRes=function(e){return!!this._fileDic[e]},r.prototype.getResState=function(e){var t=this._fileDic[e];return void 0===t?0:t?3:1},r.prototype.destroyRes=function(e){var t=this._fileDic[e];return t?(this._fileDic[e]=null,this.onResDestroy(t),!0):!1},r.prototype.onResDestroy=function(e){},r.prototype.getLoader=function(){var e=this,t=e._fLoaders.pop();return t?t:(t=e.newLoader(),t.addEventListener(egret.Event.COMPLETE,e.onLoadFinish,e),t.addEventListener(egret.IOErrorEvent.IO_ERROR,e.onLoadFinish,e),t)},r.prototype.analyzeData=function(e,t){t(e.data)},r.prototype.onLoadFinish=function(e){var t=this,r=t._loadDic,n=e.$target,o=n.ud,a=r[o];delete r[o];for(var i=!0,s=0,p=a;s<p.length;s++){var u=p[s];if(!u.pre){i=!1;break}}var f,c=t.finHandler,l=!1;if(e.$type==egret.Event.COMPLETE&&(f=t._fileDic[o],!f&&n.data&&(t._canGC&&i?(f=n.data,t._fileDic[o]=null):(l=!0,t.analyzeData(n,function(e){t._fileDic[o]=e;for(var r=0,n=a;r<n.length;r++){var i=n[r];c.onLoadFin(i)}})))),!l)for(var d=0,v=a;d<v.length;d++){var u=v[d];c.onLoadFin(u)}t.freeLoader(n)},r.prototype.freeLoader=function(e){e.data=null,e.ud=null,this._fLoaders.push(e)},r.prototype.doGC=function(){var e=this;if(e._canGC){var t=e._fileDic,r=egret.getTimer();for(var n in t){var o=t[n];o&&!o.$hasRef()&&(!o.$tm||o.$tm<r)&&(t[n]=null,e.onResDestroy(o))}}},r}(egret.HashObject);e.AnalyzerBase=o,__reflect(o.prototype,"RES.AnalyzerBase",["RES.ITpLoader"])}(RES||(RES={}));var RES;!function(e){var t=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return __extends(r,t),r.prototype.newLoader=function(){var t=new e.RequestLoader;return t.responseType=egret.HttpResponseType.ARRAY_BUFFER,t},r}(e.AnalyzerBase);e.BinAnalyzer=t,__reflect(t.prototype,"RES.BinAnalyzer")}(RES||(RES={}));var RES;!function(e){var t=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e._canGC=!0,e}return __extends(r,t),r.prototype.analyzeData=function(t,r){var n=this,o=t.data,a=new Uint32Array(o,0,2),i=a[0],s=a[1],p=new Uint8Array(o,8+i,s);egret.BitmapData.create("arraybuffer",p,function(t){var a=new e.TexData;a._setBitmapData(t);var p,u,f,c=new Uint8Array(o,8,i),l="";for(p=0,u=c.length;u>p;p++)f=c[p],l+=String.fromCharCode((f<<4&255)+(f>>4));var d,v=i+s+8;if(o.byteLength>v){d="";var _=new Uint16Array(o,v);for(p=0,u=_.length;u>p;p++)f=_[p],d+=String.fromCharCode((f<<8&255)+(f>>8))}n.parseSheet(a,l,d),r(a)})},r.prototype.parseSheet=function(e,t,r){var n=JSON.parse(t),o=n.frames;o&&(e.conf=o)},r.prototype.onResDestroy=function(e){e.dispose()},r}(e.BinAnalyzer);e.SheetAnalyzer=t,__reflect(t.prototype,"RES.SheetAnalyzer")}(RES||(RES={}));var RES;!function(e){var t=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return __extends(r,t),r.prototype.newLoader=function(){var t=new e.RequestLoader;return t.responseType=egret.HttpResponseType.TEXT,t},r.prototype.analyzeData=function(e,t){var r=null;try{r=JSON.parse(e.data)}catch(n){egret.$warn(1017,e.ud,r)}t(r)},r}(e.BinAnalyzer);e.JsonAnalyzer=t,__reflect(t.prototype,"RES.JsonAnalyzer")}(RES||(RES={}));var RES;!function(e){var t=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._ref=0,t}return __extends(t,e),Object.defineProperty(t.prototype,"data",{get:function(){return this._data},set:function(e){var t=this,r=t._data;r&&(r.removeEventListener(egret.Event.COMPLETE,t.dispatchEvent,t),r.removeEventListener(egret.IOErrorEvent.IO_ERROR,t.dispatchEvent,t)),t._data=e,e&&(e.addEventListener(egret.Event.COMPLETE,t.dispatchEvent,t),e.addEventListener(egret.IOErrorEvent.IO_ERROR,t.dispatchEvent,t))},enumerable:!0,configurable:!0}),t.prototype.$hasRef=function(){return this._ref>0},t.prototype.$addRef=function(){this._ref++},t.prototype.$subRef=function(){this._ref--},t.prototype.load=function(e){this.data.load(e)},t}(egret.EventDispatcher);e.SoundRes=t,__reflect(t.prototype,"RES.SoundRes",["RES.IResData","RES.ILoader"]);var r=function(e){function r(){var t=null!==e&&e.apply(this,arguments)||this;return t._canGC=!0,t}return __extends(r,e),r.prototype.newLoader=function(){var e=new t;return e.data=new egret.Sound,e},r.prototype.analyzeData=function(e,t){t(e)},r.prototype.freeLoader=function(e){var t=this;e.removeEventListener(egret.Event.COMPLETE,t.onLoadFinish,t),e.removeEventListener(egret.IOErrorEvent.IO_ERROR,t.onLoadFinish,t)},r.prototype.onResDestroy=function(e){e.data.close(),e.data=null},r}(e.AnalyzerBase);e.SoundAnalyzer=r,__reflect(r.prototype,"RES.SoundAnalyzer")}(RES||(RES={}));var RES;!function(e){var t=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e._canGC=!0,e.recycler=[],e}return __extends(r,t),r.prototype.newLoader=function(){return new egret.ImageLoader},r.prototype.analyzeData=function(t,r){var n=new e.TexData;n._setBitmapData(t.data),r(n)},r.prototype.onResDestroy=function(e){e.dispose()},r}(e.AnalyzerBase);e.ImageAnalyzer=t,__reflect(t.prototype,"RES.ImageAnalyzer")}(RES||(RES={}));var RES;!function(e){var t=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return __extends(r,t),r.prototype.newLoader=function(){var t=new e.RequestLoader;return t.responseType=egret.HttpResponseType.TEXT,t},r}(e.BinAnalyzer);e.TextAnalyzer=t,__reflect(t.prototype,"RES.TextAnalyzer")}(RES||(RES={}));var RES;!function(e){var t=function(t){function r(e){var r=t.call(this)||this,n=r;return n._loading=0,n._geting=0,n.maxLoad=3,n.retryCnt=3,n._gets=[],n._waits=[],n._waitDic={},n._waitGpDic={},n._preGps=[],n._loaders=e,r}return __extends(r,t),r.prototype.stopGroup=function(e){var t=this,r=t._waitGpDic[e];if(r){delete t._waitGpDic[e];for(var n=r.itms,o=t._waits,a=t._gets,i=t._waitDic,s=0,p=n;s<p.length;s++){var u=p[s],f=u[0],c=i[f];if(c&&!c.cbs){var l=c.gps,d=l.indexOf(e);if(d>=0)if(1==l.length){l.length=0;var v=c.load?a:o;d=v.indexOf(c),d>=0&&v.splice(d,1)}else l.splice(d,1)}}}},r.prototype.preLoadGroup=function(t,r){var n=this;if(n._preGps.indexOf(t)>=0)return void e.ResourceEvent.dispatchFin(n,e.ResourceEvent.GROUP_COMPLETE,t);var o=r.length;if(!(0>=o)){var a=n._waitGpDic[t];a||n._loadGp(t,r,-1e3,!0)}},r.prototype.loadGroup=function(t,r,n){var o=this,a=r.length;if(0>=a)return void e.ResourceEvent.dispatchFin(o,e.ResourceEvent.GROUP_COMPLETE,t);var i=o._waitGpDic[t];i||((!n||0>n)&&(n=0),o._loadGp(t,r,n,!1))},r.prototype._loadGp=function(t,r,n,o){for(var a,i=this,s=i._waits,p=i._gets,u=i.getInsPos(s,n),f=[],c=[],l=i._loaders,d=i._waitDic,v=[],_=0,h=r;_<h.length;_++){var y=h[_],g=y[0],R=l[y[1]],E=R.getResState(g);switch(E){case 3:f.push(g);break;case 2:f.push(g),c.push(g);break;case 1:if(o){f.push(g);break}default:if(a=d[g]){o||(a.pre=o);var S=a.gps;if(S||(S=a.gps=[]),S.push(t),!a.load&&a.pri<n){a.pri=n;var m=s.indexOf(a);m>0&&(u--,s.splice(m,1),v.push(a))}}else a={itm:y,gps:[t],pri:n,load:1==E,pre:o},d[g]=a,a.load?p.push(a):v.push(a)}}if(f.length==r.length)return o&&i._preGps.push(t),void e.ResourceEvent.dispatchFin(i,e.ResourceEvent.GROUP_COMPLETE,t,c.length>0);var L={gp:t,itms:r,fins:f,fails:c,pre:o};i._waitGpDic[t]=L,u>=s.length?Array.prototype.push.apply(s,v):(v.unshift(u,0),Array.prototype.splice.apply(s,v)),i.next()},r.prototype.loadItm=function(e,t,r){var n=this,o=e[0],a=n._loaders[e[1]],i=a.getResState(o);switch(i){case 3:return void(r&&r.fun.call(r.tar,a.getRes(o),e));case 2:return void(r&&r.fun.call(r.tar,null,e))}(!t||0>t)&&(t=0);var s=n._waits,p=n._waitDic[o];if(p){if(r){var u=p.cbs;u?u.push(r):p.cbs=[r]}if(!p.load&&t>p.pri){p.pri=t;var f=n.getInsPos(s,t),c=s.indexOf(p);c>0&&(s.splice(f,0,p),s.splice(c,1))}}else{if(p={itm:e,pri:t,load:1==i,pre:!1},r&&(p.cbs=[r]),p.load)n._gets.push(p);else{var f=n.getInsPos(s,t);f>=s.length?s.push(p):s.splice(f,0,p)}this.next()}},r.prototype.getInsPos=function(e,t){var r=0,n=e.length;for(r=0;n>r;++r){var o=e[r];if(o.pri<t)return r}return n},r.prototype.next=function(){var e=this,t=e._waits,r=t.length,n=0;r>0&&(n=t[r-1].pri);for(var o=e._gets,a=o.length;a>0&&(e._geting<=2||e._loading+e._geting<e.maxLoad)&&(a--,!(e.startLoad(o.pop())&&(e._geting++,e._geting>=2&&(0==a||o[a-1].pri<n)))););for(;r>0&&e._loading+e._geting<e.maxLoad;)e.startLoad(t.pop())&&e._loading++,r--;for(;r>0&&e._loading<=0&&!(t[r-1].pri<0);)e.startLoad(t.pop())&&e._loading++,r--},r.prototype.startLoad=function(e){var t=this,r=e.itm,n=t._loaders[r[1]];return n.hasRes(r[0])?(egret.$callAsync(t.onLoadFin,t,e),!1):(n.loadFile(e),!0)},r.prototype.onLoadFin=function(t){var r=this;t.load?r._geting--:r._loading--;var n=t.itm,o=n[0];delete r._waitDic[o];var a=r._loaders[n[1]],i=t.gps;if(i)for(var s=0,p=i;s<p.length;s++){var u=p[s],f=r._waitGpDic[u];if(f){var c=f.fins;if(c.indexOf(o)<0){c.push(o),a.hasRes(o)||f.fails.push(o);var l=f.itms.length,d=c.length;e.ResourceEvent.dispatchProgress(r,e.ResourceEvent.GROUP_PROGRESS,u,d,l),d>=l&&(delete r._waitGpDic[u],f.pre&&r._preGps.push(u),e.ResourceEvent.dispatchFin(r,e.ResourceEvent.GROUP_COMPLETE,u,f.fails.length>0))}}}var v=t.cbs;if(v)for(var _=a.getRes(o),h=0,y=v;h<y.length;h++){var g=y[h];g.fun.call(g.tar,_,n)}r.next()},r}(egret.EventDispatcher);e.ResourceLoader=t,__reflect(t.prototype,"RES.ResourceLoader",["RES.ILoadFinHandler"])}(RES||(RES={}));var RES;!function(e){var t=function(){function e(){var e=this;e._resDic={},e._gpDic={}}return e.prototype.getItm=function(e){return this._resDic[e]},e.prototype.getGpItms=function(e){return this._gpDic[e]},e.prototype.parseConf=function(e,t){var r,n,o,a=e.resources,i=this._resDic;if(a)for(n=a.length,r=0;n>r;r++)o=a[r],o[0]=t+o[0],i[o[2]]=o;var s=e.groups;if(s){var p=this._gpDic;for(n=s.length,r=0;n>r;r++){for(var u=s[r],f=u.name,c=[],l=u.keys,d=l.length,v=0;d>v;v++){var _=l[v];o=i[_],o&&c.push(o)}p[f]=c}}},e}();e.ResourceConfig=t,__reflect(t.prototype,"RES.ResourceConfig")}(RES||(RES={}));var RES;!function(e){var t=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e._canGC=!0,e}return __extends(r,t),r.prototype.analyzeData=function(r,n){t.prototype.analyzeData.call(this,r,function(t){var r=t.conf,o=new e.FontRes(t,r.frames);o.charTrans=r.charTrans,n(o)})},r.prototype.parseSheet=function(e,t,r){var n=JSON.parse(t);e.conf={frames:n},r&&(e.conf.charTrans=JSON.parse(r))},r}(e.SheetAnalyzer);e.FontAnalyzer=t,__reflect(t.prototype,"RES.FontAnalyzer")}(RES||(RES={}));var RES;!function(e){var t=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._canGC=!0,t}return __extends(t,e),t.prototype.parseSheet=function(e,t,r){e.conf=JSON.parse(t)},t}(e.SheetAnalyzer);e.McAnalyzer=t,__reflect(t.prototype,"RES.McAnalyzer")}(RES||(RES={}));var RES;!function(e){var t=function(e){function t(t,r,n){return void 0===r&&(r=!1),void 0===n&&(n=!1),e.call(this,t,r,n)||this}return __extends(t,e),t.dispatchProgress=function(e,r,n,o,a){var i=egret.Event.create(t,r);i.groupName=n,i.itemsLoaded=o,i.itemsTotal=a;var s=e.dispatchEvent(i);return egret.Event.release(i),s},t.dispatchFin=function(e,r,n,o){var a=egret.Event.create(t,r);a.groupName=n,a.isErr=o;var i=e.dispatchEvent(a);return egret.Event.release(a),i},t.CONFIG_COMPLETE="configComplete",t.GROUP_PROGRESS="groupProgress",t.GROUP_COMPLETE="groupComplete",t}(egret.Event);e.ResourceEvent=t,__reflect(t.prototype,"RES.ResourceEvent")}(RES||(RES={}));var RES;!function(e){}(RES||(RES={}));var RES;!function(e){function t(e){G=e}function r(){return G}function n(t,r){var n=e.resConf.getGpItms(t);n&&w.loadGroup(t,n,r)}function o(e,t,r){w.loadGroup(e,t,r)}function a(t){var r=e.resConf.getGpItms(t);r&&w.preLoadGroup(t,r)}function i(e,t){w.preLoadGroup(e,t)}function s(e){w.stopGroup(e)}function p(t){return!!e.resConf.getItm(t)}function u(t){return e.resConf.getItm(t)}function f(t){var r=e.resConf.getItm(t);if(r){var n=O[r[1]];if(n)return n.getRes(r[0])}return null}function c(t,r,n){var o=e.resConf.getItm(t);if(o){var a=O[o[1]];if(a){var i=a.getRes(o[0]);return i?void egret.$callAsync(r,n,i,t):void w.loadItm(o,0,{fun:function(e){egret.$callAsync(r,n,e,t)},tar:e})}}egret.$callAsync(r,n,null,t)}function l(t,r,n,o){var a=O[r];if(!a)return void egret.$callAsync(n,o,null,t);var i=a.getRes(t);return i?void egret.$callAsync(n,o,i,t):void w.loadItm([t,r],0,{fun:function(e){n.call(o,e,t)},tar:e})}function d(e,t){var r=O[t];return r?r.getRes(e):null}function v(t){var r=e.resConf.getItm(t);if(r){var n=O[r[1]];n&&n.destroyRes(r[0])}}function _(e,t){var r=O[t];r&&r.destroyRes(e)}function h(){for(var e in O)O[e].doGC()}function y(e){w.maxLoad=e}function g(e){w.retryCnt=e}function R(e,t,r,n,o){void 0===n&&(n=!1),void 0===o&&(o=0),w.addEventListener(e,t,r,n,o)}function E(e,t,r,n){void 0===n&&(n=!1),w.removeEventListener(e,t,r,n)}function S(e){return G?G.getVirtualUrl(e):e}function m(){O.bin=new e.BinAnalyzer,O.image=new e.ImageAnalyzer,O.txt=new e.TextAnalyzer,O.json=new e.JsonAnalyzer,O.st=new e.SheetAnalyzer,O.fnt=new e.FontAnalyzer,O.sound=new e.SoundAnalyzer,O.mc=new e.McAnalyzer,e.resConf=new e.ResourceConfig,w=new e.ResourceLoader(O);for(var t in O)O[t].finHandler=w}function L(e,t){O[e]=t,t.finHandler=w}function D(t,r){var n=[t,"json",r];w.loadItm(n,-1,{fun:C,tar:e})}function C(t,r){var n=r[0];return t?(e.resConf.parseConf(t,r[2]),O[r[1]].destroyRes(n),void e.ResourceEvent.dispatchFin(w,e.ResourceEvent.CONFIG_COMPLETE,n)):void e.ResourceEvent.dispatchFin(w,e.ResourceEvent.CONFIG_COMPLETE,n,!0)}var w,G;e.regVerCtrl=t,e.getVerCtrl=r,e.loadGroup=n,e.loadCustomGroup=o,e.perLoadGroup=a,e.perLoadCustomGroup=i,e.stopGroup=s,e.hasRes=p,e.getResConf=u,e.getRes=f,e.getResAsync=c,e.getUrlResAsync=l,e.getUrlRes=d,e.destroyRes=v,e.destroyUrl=_,e.doGC=h,e.setMaxLoading=y,e.setMaxRetry=g,e.addEventListener=R,e.removeEventListener=E,e.$getVirtualUrl=S;var O={};e.regAnalyzer=L,e.loadConfig=D,m()}(RES||(RES={}));